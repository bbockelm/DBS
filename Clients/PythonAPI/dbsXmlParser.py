#!/usr/bin/env python
#
# $Id$
#
# Base class for parsing xml files generated by phedex or other utilities.
#

import string
import dbsException
import dbsLogManager

from xml.dom.minidom import parse
from xml.parsers.expat import ExpatError

DEFAULT_STRING_ENCODING_ = "ascii"


##############################################################################
# Exception classes.

class DbsXmlParserException(dbsException.DbsException):

  def __init__ (self, **kwargs):
    """ Initialization. """
    dbsException.DbsException.__init__(self, **kwargs)

class InvalidInputXmlFile(DbsXmlParserException):

  def __init__ (self, **kwargs):
    """ Initialization. """
    DbsXmlParserException.__init__(self, **kwargs)
  
##############################################################################
# Parser class.

class DbsXmlParser:

  def __init__(self, xmlFile):
    """ Constructor. """
    self._xmlFile = xmlFile
    funcName = "%s.%s" % (self.__class__.__name__, "__init__()")
    logManager = dbsLogManager.getInstance()
    try:
      self._dom = parse(xmlFile)
      logManager.log(
	what="Successfully parsed file %s." % (xmlFile),
	where=funcName,
	logLevel=dbsLogManager.LOG_LEVEL_DEBUG_)
    except (IOError, ExpatError), ex:
      logManager.log(
	what="Could not parse file %s: %s" % (xmlFile, ex),
	where=funcName,
	logLevel=dbsLogManager.LOG_LEVEL_ERROR_)
      raise InvalidInputXmlFile(exception=ex)
    except Exception, ex:
      logManager.log(
	what="Could not parse file %s: %s" % (xmlFile, ex),
	where=funcName,
	logLevel=dbsLogManager.LOG_LEVEL_ERROR_)
      raise DbsXmlParserException(exception=ex)

  def getDom(self):
    """ Return dom object. """
    return self._dom

  def getXmlFile(self):
    """ Return parsed xml file. """
    return self._xmlFile
  
  def parseDocument(self):
    """
    Process the document tree. The derived parser classes have to implement
    this method.
    """
    raise dbsException.MethodNotImplemented(args="This method should be overridden in the derived DBS XML parser class.")


##############################################################################
# Unit testing.

if __name__ == "__main__":
  try:
    parser = DbsXmlParser("tmpFile.10134.1129745508.25.xml")
  except dbsException.DbsException, ex:  
    print "Caught exception %s: %s" % (ex.getClassName(), ex.getErrorMessage())
  print "Done"
